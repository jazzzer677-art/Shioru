--// Settings
local FillColor = Color3.fromRGB(175,25,255)
local DepthMode = "AlwaysOnTop"
local FillTransparency = 0.5
local OutlineColor = Color3.fromRGB(255,255,255)
local OutlineTransparency = 0

local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Camera = workspace.CurrentCamera
local lp = Players.LocalPlayer

--// Folder เก็บ Highlight
local Storage = Instance.new("Folder")
Storage.Name = "Highlight_Storage"
Storage.Parent = CoreGui

local highlights = {}
local connections = {}

--// FOV Settings
local FOVRadius = 300
local FOVCircle = Drawing.new("Circle")
FOVCircle.Radius = FOVRadius
FOVCircle.Color = Color3.fromRGB(255,0,0)
FOVCircle.Thickness = 3
FOVCircle.Filled = false
FOVCircle.Transparency = 0.5
FOVCircle.NumSides = 100

--// Silent Aim Settings
local Silent = getgenv().Silent and getgenv().Silent.Settings or {
    Toggled = true,
    AimPart = "HumanoidRootPart"
}

--// สร้าง Highlight สำหรับผู้เล่น
local function CreateHighlight(plr)
    local hl = Instance.new("Highlight")
    hl.Name = plr.Name
    hl.FillColor = FillColor
    hl.DepthMode = DepthMode
    hl.FillTransparency = FillTransparency
    hl.OutlineColor = OutlineColor
    hl.OutlineTransparency = OutlineTransparency
    hl.Parent = Storage

    if plr.Character then
        hl.Adornee = plr.Character
    end

    connections[plr] = plr.CharacterAdded:Connect(function(char)
        hl.Adornee = char
    end)

    highlights[plr] = hl
end

--// Player Added/Removing
Players.PlayerAdded:Connect(CreateHighlight)
for _,v in pairs(Players:GetPlayers()) do
    if v ~= lp then
        CreateHighlight(v)
    end
end

Players.PlayerRemoving:Connect(function(plr)
    if highlights[plr] then
        highlights[plr]:Destroy()
        highlights[plr] = nil
    end
    if connections[plr] then
        connections[plr]:Disconnect()
        connections[plr] = nil
    end
end)

--// ฟังก์ชันหาเป้าหมายใน POV + FOV
local function GetTargetsInFOV()
    local mousePos = UserInputService:GetMouseLocation()
    local targets = {}

    for plr, hl in pairs(highlights) do
        if plr ~= lp and plr.Character and plr.Character:FindFirstChild(Silent.AimPart) then
            local part = plr.Character[Silent.AimPart]
            local screenPos, onScreen = Camera:WorldToViewportPoint(part.Position)

            -- ตรวจสอบว่าอยู่ใน POV (หน้าจอ) และใน FOV
            if onScreen then
                local dist = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude
                if dist <= FOVRadius then
                    hl.Enabled = true -- แสดง Highlight
                    table.insert(targets, plr) -- ใส่ target ยิง
                else
                    hl.Enabled = false
                end
            else
                hl.Enabled = false
            end
        end
    end

    return targets
end

--// ยิงอัตโนมัติ
local function SilentShoot()
    local targets = GetTargetsInFOV()
    for _, target in pairs(targets) do
        if target and target.Character and target.Character:FindFirstChild(Silent.AimPart) then
            local args = {
                "MOUSE",
                Vector3.new(
                    target.Character[Silent.AimPart].Position.X,
                    target.Character[Silent.AimPart].Position.Y,
                    target.Character[Silent.AimPart].Position.Z
                )
            }
            local mainEvent = ReplicatedStorage:WaitForChild("MAINEVENT")
            if mainEvent then
                mainEvent:FireServer(unpack(args))
            end
        end
    end
end

--// อัพเดต FOV + Highlight + Silent Aim
RunService.RenderStepped:Connect(function()
    local mousePos = UserInputService:GetMouseLocation()
    FOVCircle.Position = Vector2.new(mousePos.X, mousePos.Y)

    if Silent.Toggled then
        SilentShoot()
    end
end)
